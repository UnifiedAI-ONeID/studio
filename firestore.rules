
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    // EVENTS
    // - Public reads for all events
    // - Any signed-in user can create (you can tighten later)
    // - Only owner can update/delete
    match /events/{eventId} {
      allow read: if true;

      allow create: if isSignedIn();

      allow update, delete: if isSignedIn()
                            && request.auth.uid == resource.data.ownerId;
    }

    // VENUES
    // - Public readable (for directory / landing)
    // - Only signed-in user who owns the venue can write
    match /venues/{venueId} {
      allow read: if true;

      allow create: if isSignedIn();

      allow update, delete: if isSignedIn()
                            && request.auth.uid == resource.data.ownerId;
    }

    // THREADS (Commons)
    // - Public readable
    // - Any signed-in user can create
    // - Only author can update/delete
    match /threads/{threadId} {
      allow read: if true;

      allow create: if isSignedIn();

      allow update, delete: if isSignedIn()
                            && request.auth.uid == resource.data.authorId;
    }

    // THREAD COMMENTS
    // - Public readable
    // - Any signed-in user can create
    // - Only author can update/delete
    match /threads/{threadId}/comments/{commentId} {
      allow read: if true;

      allow create: if isSignedIn();

      allow update, delete: if isSignedIn()
                            && request.auth.uid == resource.data.authorId;
    }

    // USERS / PROFILES
    // - Everyone can read basic profiles
    // - Only the user can write their own document
    match /users/{userId} {
      allow read: if true;

      allow create, update, delete: if isSignedIn()
                                    && request.auth.uid == userId;
    }

    // Fallback: deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
