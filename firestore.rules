rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      // In a real app, this would be more secure, e.g., checking a custom claim.
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isOwner(ownerId) {
      return isSignedIn() && request.auth.uid == ownerId;
    }
    
    // --- Request Operation Helpers ---
    function isCreating() {
      return request.method == 'create';
    }
    function isUpdating() {
      return request.method == 'update';
    }
    function isDeleting() {
      return request.method == 'delete';
    }

    // --- Data & Schema Helpers ---
    function incomingData() {
      return request.resource.data;
    }

    function existingData() {
      return resource.data;
    }
    
    function isUnchanged(field) {
      return incomingData()[field] == existingData()[field];
    }
    
    // --- Schema Validation Functions ---

    function isValidUserProfile() {
      let data = incomingData();
      let isNewUser = isCreating();

      return data.uid == request.auth.uid
          && data.email is string
          && (data.displayName == null || (data.displayName is string && data.displayName.size() > 0 && data.displayName.size() < 50))
          && (data.photoURL == null || (data.photoURL is string && data.photoURL.matches('^https?://.*')))
          && (isNewUser ? data.role == 'user' : isUnchanged('role')) // Can't change your own role
          && (data.homeCity == null || (data.homeCity is string && data.homeCity.size() < 50));
    }

    function isValidEvent() {
      let data = incomingData();
      return data.title is string && data.title.size() >= 5 && data.title.size() < 100
          && data.description is string && data.description.size() >= 10 && data.description.size() < 5000
          && data.category is string && data.category.size() > 0
          && data.startTime is timestamp
          && data.hostId is string
          && data.status is string
          && data.visibility is string
          && data.approvalStatus is string
          && data.createdBy is string;
    }

    function isValidVenue() {
        let data = incomingData();
        return data.name is string && data.name.size() >= 3 && data.name.size() < 100
            && data.categories is list && data.categories.size() > 0
            && data.address is string && data.address.size() >= 5 && data.address.size() < 200
            && data.neighborhood is string
            && (data.description == null || (data.description is string && data.description.size() < 5000))
            && data.createdBy is string;
    }

    function isValidThread() {
        let data = incomingData();
        return data.title is string && data.title.size() >= 5 && data.title.size() < 150
            && data.body is string && data.body.size() >= 10 && data.body.size() < 10000
            && data.topic is string && data.topic.size() > 0
            && data.authorId is string;
    }

    function isValidComment() {
        let data = incomingData();
        return data.threadId is string
            && data.body is string && data.body.size() > 0 && data.body.size() < 5000
            && data.createdBy is string;
    }


    // --- Rules ---

    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if request.auth.uid == userId && isValidUserProfile();
      allow update: if (isUser(userId) && isValidUserProfile()) || isAdmin();
      allow delete: if isUser(userId) || isAdmin();
    }
    
    match /events/{eventId} {
      allow read: if true;
      allow create: if isSignedIn() && isOwner(incomingData().createdBy) && isValidEvent();
      allow update: if (isOwner(existingData().createdBy) || isAdmin()) && isValidEvent() && isUnchanged('createdAt') && isUnchanged('createdBy');
      allow delete: if isOwner(existingData().createdBy) || isAdmin();
    }
    
    match /venues/{venueId} {
      allow read: if true;
      allow create: if isSignedIn() && isOwner(incomingData().createdBy) && isValidVenue();
      allow update: if (isOwner(existingData().createdBy) || isAdmin()) && isValidVenue() && isUnchanged('createdAt') && isUnchanged('createdBy');
      allow delete: if isOwner(existingData().createdBy) || isAdmin();
    }
    
    match /threads/{threadId} {
      allow read: if true;
      allow create: if isSignedIn() && isOwner(incomingData().authorId) && isValidThread();
      allow update: if (isOwner(existingData().authorId) || isAdmin()) && isValidThread() && isUnchanged('createdAt') && isUnchanged('authorId');
      allow delete: if isOwner(existingData().authorId) || isAdmin();

      match /comments/{commentId} {
        allow read: if true;
        allow create: if isSignedIn() && isOwner(incomingData().createdBy) && isValidComment();
        allow update: if (isOwner(existingData().createdBy) || isAdmin()) && isValidComment() && isUnchanged('createdAt') && isUnchanged('createdBy');
        allow delete: if isOwner(existingData().createdBy) || isAdmin();
      }
    }

    match /eventInteractions/{interactionId} {
      allow read, delete: if isOwner(resource.data.userId);
      allow create, update: if isOwner(incomingData().userId);
    }
    
    match /follows/{followId} {
        allow read, delete: if isOwner(resource.data.userId);
        allow create: if isOwner(incomingData().userId);
    }
    
    match /reports/{reportId} {
        allow create: if isSignedIn() && isOwner(incomingData().createdBy);
        allow read, update, delete: if isAdmin();
    }
    
    match /newsletterSubscribers/{subscriberId} {
        allow create: if true;
        allow read, update, delete: if isAdmin();
    }
  }
}
