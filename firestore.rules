
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    // EVENTS
    // - Public reads for published events
    // - Any signed-in user can create
    // - Only owner can update/delete
    match /events/{eventId} {
      allow read: if resource.data.status == "published" && resource.data.visibility == "public";
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.hostId;
    }

    // VENUES
    // - Public reads for approved venues
    // - Any signed-in user can create
    // - Only owner can update/delete
    match /venues/{venueId} {
      allow read: if resource.data.status == 'approved';
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.createdBy;
    }

    // THREADS (Commons)
    // - Public readable
    // - Any signed-in user can create
    // - Only author can update/delete
    match /threads/{threadId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.authorId;
    }

    // THREAD COMMENTS
    // - Public readable
    // - Any signed-in user can create
    // - Only author can update/delete
    match /threads/{threadId}/comments/{commentId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.createdBy;
    }
    
    // EVENT INTERACTIONS (interested, going, saved)
    // - Readable by the user who created them
    // - Writable by the user who owns them
    match /eventInteractions/{interactionId} {
        allow read, write: if isSignedIn() && request.auth.uid == resource.data.userId;
    }

    // FOLLOWS
    // - Readable and writable by the user who owns the follow relationship.
     match /users/{userId}/follows/{followId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }
     match /follows/{followId} {
      allow read, write: if isSignedIn() && request.auth.uid == resource.data.userId;
    }

    // USERS / PROFILES
    // - Everyone can read basic profiles
    // - Only the user can write their own document
    match /users/{userId} {
      allow read: if true;
      allow create, update, delete: if isSignedIn() && request.auth.uid == userId;
    }
    
    // NEWSLETTER SUBSCRIBERS
    // - Allow anyone to sign up
     match /newsletterSubscribers/{subscriberId} {
      allow create: if true;
    }

    // REPORTS
    // - Only signed in users can create reports
    match /reports/{reportId} {
      allow create: if isSignedIn();
    }

    // REACTIONS
    // - Allow signed in users to manage their own reactions
    match /threads/{threadId}/reactions/{reactionId} {
        allow read, write: if isSignedIn() && request.auth.uid == resource.data.userId;
    }
     match /threads/{threadId}/comments/{commentId}/reactions/{reactionId} {
        allow read, write: if isSignedIn() && request.auth.uid == resource.data.userId;
    }
     match /comments/{commentId}/reactions/{reactionId} {
        allow read, write: if isSignedIn() && request.auth.uid == resource.data.userId;
    }

  }
}
