rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isOwner(ownerId) {
      return isSignedIn() && request.auth.uid == ownerId;
    }
    
    // --- Request Operation Helpers ---
    function isCreating() {
      return request.method == 'create';
    }
    function isUpdating() {
      return request.method == 'update';
    }
    function isDeleting() {
      return request.method == 'delete';
    }

    // --- Data & Schema Helpers ---
    function incomingData() {
      return request.resource.data;
    }

    function existingData() {
      return resource.data;
    }
    
    function isUnchanged(field) {
      return incomingData()[field] == existingData()[field];
    }
    
    // --- Schema Validation Functions ---

    function isValidUserProfile() {
      let data = incomingData();
      return data.uid == request.auth.uid
          && data.email is string
          && (data.displayName == null || data.displayName is string)
          && (data.photoURL == null || data.photoURL is string)
          && (data.role == 'user' || data.role == 'admin');
    }

    function isValidEvent() {
      let data = incomingData();
      return data.title is string && data.title.size() > 0
          && data.category is string
          && data.startTime is timestamp
          && data.hostId is string
          && data.status is string
          && data.visibility is string
          && data.approvalStatus is string
          && data.createdBy is string;
    }

    function isValidVenue() {
        let data = incomingData();
        return data.name is string && data.name.size() > 0
            && data.type is string
            && data.address is string
            && data.neighborhood is string
            && data.createdBy is string
            && data.verified is bool;
    }

    function isValidThread() {
        let data = incomingData();
        return data.title is string && data.title.size() > 0
            && data.body is string && data.body.size() > 0
            && data.topic is string
            && data.createdBy is string;
    }

    function isValidComment() {
        let data = incomingData();
        return data.threadId is string
            && data.body is string && data.body.size() > 0
            && data.createdBy is string;
    }


    // --- Rules ---

    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isUser(userId) && isValidUserProfile();
      allow update: if isUser(userId) && isValidUserProfile();
      allow delete: if isUser(userId) || isAdmin();
    }
    
    match /events/{eventId} {
      allow read: if true;
      allow create: if isSignedIn() && isOwner(incomingData().createdBy) && isValidEvent();
      allow update: if (isOwner(existingData().createdBy) || isAdmin()) && isValidEvent();
      allow delete: if isOwner(existingData().createdBy) || isAdmin();
    }
    
    match /venues/{venueId} {
      allow read: if true;
      allow create: if isSignedIn() && isOwner(incomingData().createdBy) && isValidVenue();
      allow update, delete: if (isOwner(existingData().createdBy) || isAdmin());
    }
    
    match /threads/{threadId} {
      allow read: if true;
      allow create: if isSignedIn() && isOwner(incomingData().createdBy) && isValidThread();
      allow update: if (isOwner(existingData().createdBy) || isAdmin()) && isUnchanged('createdAt');
      allow delete: if isOwner(existingData().createdBy) || isAdmin();

      match /comments/{commentId} {
        allow read: if true;
        allow create: if isSignedIn() && isOwner(incomingData().createdBy) && isValidComment();
        allow update: if (isOwner(existingData().createdBy) || isAdmin()) && isUnchanged('createdAt');
        allow delete: if isOwner(existingData().createdBy) || isAdmin();
      }
    }

    match /eventInteractions/{interactionId} {
      allow read, delete: if isOwner(existingData().userId);
      allow create, update: if isOwner(incomingData().userId);
    }
    
    match /follows/{followId} {
        allow read, delete: if isOwner(existingData().userId);
        allow create: if isOwner(incomingData().userId);
    }
    
    match /reports/{reportId} {
        allow create: if isSignedIn() && isOwner(incomingData().createdBy);
        allow read, update, delete: if isAdmin();
    }
    
    match /newsletterSubscribers/{subscriberId} {
        allow create: if true;
        allow read, update, delete: if isAdmin();
    }
  }
}
