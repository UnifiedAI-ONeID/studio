rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      // Check for admin role in a dedicated document.
      // Assumes a document at /appRoles/global with a map of admin UIDs.
      return isSignedIn() && get(/databases/$(database)/documents/appRoles/global).data.admins[request.auth.uid] == true;
    }

    function isOwner(ownerId) {
        return request.auth.uid == ownerId;
    }

    function incomingData() {
      return request.resource.data;
    }

    function existingData() {
      return resource.data;
    }

    // --- Rules ---

    match /users/{userId} {
      allow read: if true;
      allow create: if isUser(userId);
      // Prevent users from changing their role or createdAt timestamp
      allow update: if isUser(userId) && incomingData().createdAt == existingData().createdAt;
      allow delete: if isUser(userId) || isAdmin();
    }

    match /events/{eventId} {
      // Public reads for published and public events
      allow read: if (existingData().status == "published" && existingData().visibility == "public") || (isSignedIn() && isOwner(existingData().hostId)) || isAdmin();

      // Any signed-in user can create events, linking themselves as the host.
      allow create: if isSignedIn() && isOwner(incomingData().hostId);

      // Hosts can update their own events (but not status), Admins can update anything.
      allow update: if (isOwner(existingData().hostId) && incomingData().hostId == existingData().hostId && incomingData().createdAt == existingData().createdAt) || isAdmin();

      // Delete: host or admin
      allow delete: if isOwner(existingData().hostId) || isAdmin();
    }

    match /venues/{venueId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update, delete: if isOwner(existingData().createdBy) || isAdmin();
    }

    match /organizations/{orgId} {
      allow read: if true;
      allow create: if isSignedIn() && isOwner(incomingData().ownerUserId);
      allow update, delete: if isOwner(existingData().ownerUserId) || isAdmin();
    }

    match /commonsThreads/{threadId} {
      allow read: if true;
      allow create: if isSignedIn() && isOwner(incomingData().authorId);
      allow update: if (isOwner(existingData().authorId) || isAdmin()) && incomingData().createdAt == existingData().createdAt;
      allow delete: if isOwner(existingData().authorId) || isAdmin();
    }
    
    match /commonsReplies/{replyId} {
        allow read: if true;
        allow create: if isSignedIn() && isOwner(incomingData().authorId);
        allow update: if (isOwner(existingData().authorId) || isAdmin()) && incomingData().createdAt == existingData().createdAt;
        allow delete: if isOwner(existingData().authorId) || isAdmin();
    }

    match /eventInteractions/{interactionId} {
      allow read: if isUser(existingData().userId);
      // Ensure the interaction ID matches the user and event
      allow create, update: if isUser(incomingData().userId) && interactionId == incomingData().userId + '_' + incomingData().eventId;
      allow delete: if isUser(existingData().userId);
    }

    match /follows/{followId} {
      allow read: if isUser(existingData().followerUserId);
      allow create: if isUser(incomingData().followerUserId) && followId == incomingData().followerUserId + '_' + incomingData().targetType + '_' + incomingData().targetId;
      allow delete: if isUser(existingData().followerUserId);
    }

    match /notifications/{notificationId} {
      allow read, update: if isUser(existingData().userId);
      allow create, delete: if isAdmin(); // Only backend can create notifications
    }

    match /newsletterSubscribers/{subscriberId} {
      allow create: if incomingData().email.matches('.+@.+\..+');
      allow read, update, delete: if isAdmin();
    }

    match /appRoles/global {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    match /landingConfig/global {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /reports/{reportId} {
      allow create: if isSignedIn() && isOwner(incomingData().createdBy);
      allow read, update, delete: if isAdmin();
    }

    match /threads/{threadId}/comments/{commentId}/reactions/{reactionId} {
        allow read: if true;
        allow create: if isSignedIn() && isOwner(incomingData().userId);
        allow delete: if isSignedIn() && isOwner(existingData().userId);
    }
  }
}
